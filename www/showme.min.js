var hexcase=0,b64pad="",chrsz=8;function hex_md5(a){return binl2hex(core_md5(str2binl(a),a.length*chrsz))}function b64_md5(a){return binl2b64(core_md5(str2binl(a),a.length*chrsz))}function str_md5(a){return binl2str(core_md5(str2binl(a),a.length*chrsz))}function hex_hmac_md5(a,f){return binl2hex(core_hmac_md5(a,f))}function b64_hmac_md5(a,f){return binl2b64(core_hmac_md5(a,f))}function str_hmac_md5(a,f){return binl2str(core_hmac_md5(a,f))}
function md5_vm_test(){return hex_md5("abc")=="900150983cd24fb0d6963f7d28e17f72"}
function core_md5(a,f){a[f>>5]|=128<<f%32;a[(f+64>>>9<<4)+14]=f;for(var b=1732584193,c=-271733879,e=-1732584194,d=271733878,g=0;g<a.length;g+=16){var n=b,o=c,m=e,i=d;b=md5_ff(b,c,e,d,a[g+0],7,-680876936);d=md5_ff(d,b,c,e,a[g+1],12,-389564586);e=md5_ff(e,d,b,c,a[g+2],17,606105819);c=md5_ff(c,e,d,b,a[g+3],22,-1044525330);b=md5_ff(b,c,e,d,a[g+4],7,-176418897);d=md5_ff(d,b,c,e,a[g+5],12,1200080426);e=md5_ff(e,d,b,c,a[g+6],17,-1473231341);c=md5_ff(c,e,d,b,a[g+7],22,-45705983);b=md5_ff(b,c,e,d,a[g+8],7,
1770035416);d=md5_ff(d,b,c,e,a[g+9],12,-1958414417);e=md5_ff(e,d,b,c,a[g+10],17,-42063);c=md5_ff(c,e,d,b,a[g+11],22,-1990404162);b=md5_ff(b,c,e,d,a[g+12],7,1804603682);d=md5_ff(d,b,c,e,a[g+13],12,-40341101);e=md5_ff(e,d,b,c,a[g+14],17,-1502002290);c=md5_ff(c,e,d,b,a[g+15],22,1236535329);b=md5_gg(b,c,e,d,a[g+1],5,-165796510);d=md5_gg(d,b,c,e,a[g+6],9,-1069501632);e=md5_gg(e,d,b,c,a[g+11],14,643717713);c=md5_gg(c,e,d,b,a[g+0],20,-373897302);b=md5_gg(b,c,e,d,a[g+5],5,-701558691);d=md5_gg(d,b,c,e,a[g+
10],9,38016083);e=md5_gg(e,d,b,c,a[g+15],14,-660478335);c=md5_gg(c,e,d,b,a[g+4],20,-405537848);b=md5_gg(b,c,e,d,a[g+9],5,568446438);d=md5_gg(d,b,c,e,a[g+14],9,-1019803690);e=md5_gg(e,d,b,c,a[g+3],14,-187363961);c=md5_gg(c,e,d,b,a[g+8],20,1163531501);b=md5_gg(b,c,e,d,a[g+13],5,-1444681467);d=md5_gg(d,b,c,e,a[g+2],9,-51403784);e=md5_gg(e,d,b,c,a[g+7],14,1735328473);c=md5_gg(c,e,d,b,a[g+12],20,-1926607734);b=md5_hh(b,c,e,d,a[g+5],4,-378558);d=md5_hh(d,b,c,e,a[g+8],11,-2022574463);e=md5_hh(e,d,b,c,a[g+
11],16,1839030562);c=md5_hh(c,e,d,b,a[g+14],23,-35309556);b=md5_hh(b,c,e,d,a[g+1],4,-1530992060);d=md5_hh(d,b,c,e,a[g+4],11,1272893353);e=md5_hh(e,d,b,c,a[g+7],16,-155497632);c=md5_hh(c,e,d,b,a[g+10],23,-1094730640);b=md5_hh(b,c,e,d,a[g+13],4,681279174);d=md5_hh(d,b,c,e,a[g+0],11,-358537222);e=md5_hh(e,d,b,c,a[g+3],16,-722521979);c=md5_hh(c,e,d,b,a[g+6],23,76029189);b=md5_hh(b,c,e,d,a[g+9],4,-640364487);d=md5_hh(d,b,c,e,a[g+12],11,-421815835);e=md5_hh(e,d,b,c,a[g+15],16,530742520);c=md5_hh(c,e,d,
b,a[g+2],23,-995338651);b=md5_ii(b,c,e,d,a[g+0],6,-198630844);d=md5_ii(d,b,c,e,a[g+7],10,1126891415);e=md5_ii(e,d,b,c,a[g+14],15,-1416354905);c=md5_ii(c,e,d,b,a[g+5],21,-57434055);b=md5_ii(b,c,e,d,a[g+12],6,1700485571);d=md5_ii(d,b,c,e,a[g+3],10,-1894986606);e=md5_ii(e,d,b,c,a[g+10],15,-1051523);c=md5_ii(c,e,d,b,a[g+1],21,-2054922799);b=md5_ii(b,c,e,d,a[g+8],6,1873313359);d=md5_ii(d,b,c,e,a[g+15],10,-30611744);e=md5_ii(e,d,b,c,a[g+6],15,-1560198380);c=md5_ii(c,e,d,b,a[g+13],21,1309151649);b=md5_ii(b,
c,e,d,a[g+4],6,-145523070);d=md5_ii(d,b,c,e,a[g+11],10,-1120210379);e=md5_ii(e,d,b,c,a[g+2],15,718787259);c=md5_ii(c,e,d,b,a[g+9],21,-343485551);b=safe_add(b,n);c=safe_add(c,o);e=safe_add(e,m);d=safe_add(d,i)}return Array(b,c,e,d)}function md5_cmn(a,f,b,c,e,d){return safe_add(bit_rol(safe_add(safe_add(f,a),safe_add(c,d)),e),b)}function md5_ff(a,f,b,c,e,d,g){return md5_cmn(f&b|~f&c,a,f,e,d,g)}function md5_gg(a,f,b,c,e,d,g){return md5_cmn(f&c|b&~c,a,f,e,d,g)}
function md5_hh(a,f,b,c,e,d,g){return md5_cmn(f^b^c,a,f,e,d,g)}function md5_ii(a,f,b,c,e,d,g){return md5_cmn(b^(f|~c),a,f,e,d,g)}function core_hmac_md5(a,f){var b=str2binl(a);if(b.length>16)b=core_md5(b,a.length*chrsz);for(var c=Array(16),e=Array(16),d=0;d<16;d++){c[d]=b[d]^909522486;e[d]=b[d]^1549556828}b=core_md5(c.concat(str2binl(f)),512+f.length*chrsz);return core_md5(e.concat(b),640)}function safe_add(a,f){var b=(a&65535)+(f&65535);return(a>>16)+(f>>16)+(b>>16)<<16|b&65535}
function bit_rol(a,f){return a<<f|a>>>32-f}function str2binl(a){for(var f=[],b=(1<<chrsz)-1,c=0;c<a.length*chrsz;c+=chrsz)f[c>>5]|=(a.charCodeAt(c/chrsz)&b)<<c%32;return f}function binl2str(a){for(var f="",b=(1<<chrsz)-1,c=0;c<a.length*32;c+=chrsz)f+=String.fromCharCode(a[c>>5]>>>c%32&b);return f}function binl2hex(a){for(var f=hexcase?"0123456789ABCDEF":"0123456789abcdef",b="",c=0;c<a.length*4;c++)b+=f.charAt(a[c>>2]>>c%4*8+4&15)+f.charAt(a[c>>2]>>c%4*8&15);return b}
function binl2b64(a){for(var f="",b=0;b<a.length*4;b+=3)for(var c=(a[b>>2]>>8*(b%4)&255)<<16|(a[b+1>>2]>>8*((b+1)%4)&255)<<8|a[b+2>>2]>>8*((b+2)%4)&255,e=0;e<4;e++)f+=b*8+e*6>a.length*32?b64pad:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(c>>6*(3-e)&63);return f};var map=null,map_extent=null,documents={},extents={},properties={};function sm_init(){var a=org.polymaps.svg("svg");a=document.getElementById("map").appendChild(a);map=org.polymaps.map();map.container(a);map.zoomRange([1,17]);a=org.polymaps.image();a.url("http://spaceclaw.stamen.com/toner/{Z}/{X}/{Y}.png");map.add(a);a=org.polymaps.interact();map.add(a);a=org.polymaps.hash();map.add(a);a=org.polymaps.compass();a.zoom("small");a.pan("none");map.add(a);sm_extents_jumpto()};function sm_form_handler(){var a=document.getElementById("load_uri"),f=document.getElementById("load_file");if(a.value)if(a.value.indexOf("http")==0){sm_load_uri(a.value);a.value=""}else alert("Invalid URL!");if(f.files.length){sm_load_files(f.files);f.value=""}}function sm_form_toggle(a){document.getElementById("load_header").style.display=a?"block":"none";document.getElementById("load_form").style.display=a?"none":"block"};function sm_load_uri(a){if(!extents[a]){var f=org.polymaps.geoJson();f.url(a);var b=sm_onload(a);f.on("load",b);map.add(f);documents[a]=f;sm_extents_set_onload(a);sm_form_toggle("close")}}function sm_load_features(a,f){f||(f=hex_md5(JSON.stringify(a)));if(!extents[f]){var b=org.polymaps.geoJson();b.features(a);var c=sm_onload(f);b.on("load",c);map.add(b);documents[f]=b;sm_extents_set_onload(f);sm_form_toggle("close")}}function sm_load_files(a){for(var f=a.length,b=0;b<f;b++)sm_load_file(a[b])}
function sm_load_file(a){var f;try{f=new FileReader}catch(b){sm_load_uri(a.name);return}f.onloadend=function(c){try{geojson=JSON.parse(c.target.result)}catch(e){alert("failed to parse your file ("+a.name+"), the error was: "+e);return}sm_load_features(geojson.features,a.name)};f.readAsBinaryString(a)};function sm_onload(a){return function(f){sm_onload_json(f,a)}}
function sm_onload_json(a,f){properties[f]||(properties[f]=[]);for(var b=a.features.length,c=null,e=null,d=null,g=null,n=function(l){if(l.type=="GeometryCollection")console.log("GeometryCollections are not fully implemented yet");else if(l.type=="Polygon"){var k=l.coordinates[0];l=k.length;for(var j=0;j<l;j++){c=c?Math.min(c,k[j][1]):k[j][1];e=e?Math.min(e,k[j][0]):k[j][0];d=d?Math.max(d,k[j][1]):k[j][1];g=g?Math.max(g,k[j][0]):k[j][0]}}else if(l.type=="MultiPolygon"){k=l.coordinates[0];var r=k.length;
for(j=0;j<r;j++){l=k[j].length;for(var q=0;q<l;q++){var h=k[j][q];c=c?Math.min(c,h[1]):h[1];e=e?Math.min(e,h[0]):h[0];d=d?Math.max(d,h[1]):h[1];g=g?Math.max(g,h[0]):h[0]}}}else if(l.type=="Point"){h=l.coordinates;c=c?Math.min(c,h[1]):h[1];e=e?Math.min(e,h[0]):h[0];d=d?Math.max(d,h[1]):h[1];g=g?Math.max(g,h[0]):h[0]}else console.log("unsupported type: "+i.geometry.type)},o=0;o<b;o++){var m=a.features[o],i=m.data;if(i.bbox){c=c?Math.min(c,i.bbox[1]):i.bbox[1];e=e?Math.min(e,i.bbox[0]):i.bbox[0];d=d?
Math.max(d,i.bbox[3]):i.bbox[3];g=g?Math.max(g,i.bbox[2]):i.bbox[2]}else n(i.geometry);properties[f][o]=i.properties;var p=f+"#"+o,s=hex_md5(p);m=m.element;if(i.geometry.type!="GeometryCollection"){m.setAttribute("onmouseover",'sm_properties_mouseover("'+p+'");');m.setAttribute("onmouseout",'sm_properties_mouseout("'+p+'");');m.setAttribute("onclick",'sm_clipboard_copyto("'+p+'");');m.setAttribute("class",i.geometry.type.toLowerCase());m.setAttribute("id",s)}}extents[f]=[{lat:c,lon:e},{lat:d,lon:g}]}
;function sm_extents_set_onload(a){if(a)if(extents[a]){sm_extents_set();sm_documents_list()}else setTimeout(function(){sm_extents_set_onload(a)},200)}function sm_extents_set(){var a=null,f=null,b=null,c=null;for(uid in extents){bbox=extents[uid];a=a?Math.min(a,bbox[0].lat):bbox[0].lat;f=f?Math.min(f,bbox[0].lon):bbox[0].lon;b=b?Math.max(b,bbox[1].lat):bbox[1].lat;c=c?Math.max(c,bbox[1].lon):bbox[1].lon}map_extent=[{lat:a,lon:f},{lat:b,lon:c}];sm_extents_jumpto()}
function sm_extents_jumpto(a){sm_properties_hide();if(!a||!extents[a])if(!map_extent||map_extent[0].lat==null){map.extent([{lat:-85,lon:-180},{lat:85,lon:180}]);map.zoom(1)}else{map.extent(map_extent);map.zoom(Math.floor(map.zoom()))}else{map.extent(extents[a]);map.zoom(Math.floor(map.zoom()))}};function sm_properties_endomify(a){var f=document.createElement("ul");if(a)for(var b in a){var c=a[b],e=document.createElement("li");c=document.createTextNode(b+" : "+c);e.appendChild(c);f.appendChild(e)}return f}function sm_properties_mouseover(a){return sm_properties_show(a)}function sm_properties_mouseout(a){a=a.split("#");var f=a[0];if(properties[f])properties[f][a[1]]||sm_properties_hide()}
function sm_properties_show(a){for(var f=document.getElementsByClassName("geom-active"),b=f.length,c=0;c<b;c++){var e=f[c],d=e.getAttribute("class");d=d.replace("geom-active","");d=d.trim();e.setAttribute("class",d)}d=hex_md5(a);f=document.getElementById(d);d=f.getAttribute("class");d+=" geom-active";f.setAttribute("class",d);a=a.split("#");d=a[0];f=a[1];if(properties[d]){b=properties[d][f];a=document.getElementById("properties");a.innerHTML="";c=document.createElement("h2");c.appendChild(document.createTextNode(d+
", item #"+(Number(f)+1)));a.appendChild(c);d=sm_properties_endomify(b);if(d.children.length){b=document.createElement("li");c=document.createElement("a");c.setAttribute("class","sm_close");f=document.createTextNode("hide these properties");c.appendChild(f);c.setAttribute("onclick","sm_properties_hide();");b.appendChild(c);d.insertBefore(b,d.firstChild)}else{b=document.createElement("li");b.setAttribute("class","sm_caveat");f=document.createTextNode("this feature has no extra properties");b.appendChild(f);
d.appendChild(b)}a.appendChild(d);a.style.display="block"}}function sm_properties_hide(){var a=document.getElementById("properties");a.innerHTML="";a.style.display="none"};function sm_documents_list(){var a=document.getElementById("documents");a.innerHTML="";var f=document.createElement("ul");for(var b in documents){var c=document.createElement("li"),e=document.createElement("a"),d=document.createTextNode(b);e.appendChild(d);e.setAttribute("onclick",'sm_extents_jumpto("'+b+'");');var g=document.createElement("a");g.setAttribute("class","sm_close");d=document.createTextNode(" remove this document");g.appendChild(d);g.setAttribute("onclick",'sm_documents_remove("'+b+
'");');d=extents[b];d=[d[0].lat,d[0].lon,d[1].lat,d[1].lon];var n=document.createElement("div");n.setAttribute("class","sm_bbox");n.appendChild(document.createTextNode(d.join(", ")));c.appendChild(e);c.appendChild(g);c.appendChild(n);f.appendChild(c)}if(f.children.length!=0){if(f.children.length>1){b=document.createElement("li");c=document.createElement("a");d=document.createTextNode("show all");c.appendChild(d);c.setAttribute("onclick","sm_extents_jumpto();");b.appendChild(c);f.appendChild(b)}b=
document.createElement("h2");b.appendChild(document.createTextNode("Documents"));a.appendChild(b);a.appendChild(f)}}function sm_documents_remove(a){if(documents[a]){map.remove(documents[a]);delete documents[a];delete extents[a];sm_extents_set();sm_documents_list()}};function sm_clipboard_copyto(a){var f=a.split("#");a=f[0];f=f[1];if(properties[a]){var b=properties[a][f];if(b){b=sm_properties_endomify(b);var c=document.getElementById("clipboard"),e=document.getElementById("clipbody");e.innerHTML="";var d=document.createElement("h3");d.appendChild(document.createTextNode(a+", item #"+(Number(f)+1)));e.appendChild(d);e.appendChild(b);c.style.display="block"}else alert("This feature has no properties!")}}
function sm_clipboard_close(){var a=document.getElementById("clipboard");document.getElementById("clipbody").innerHTML="";a.style.display="none";sm_properties_hide()};
